import * as React from "react";
import useLang from "../../Hooks/useLang";
import {
  MenuItem,
  Avatar,
  Typography,
  Stack,
  Popper,
  MenuList,
  ClickAwayListener,
  Menu,
  Paper,
} from "@mui/material";

export default function MenuLang() {
  const { langHub, changeLang, currentLang } = useLang();
  const [selectedLang, setSelectedLang] = React.useState(currentLang);
  const [open, setOpen] = React.useState(false);
  const anchorRef = React.useRef(null);

  const handleToggle = () => {
    setOpen((prevOpen) => !prevOpen);
  };

  const handleClose = (event) => {
    if (anchorRef.current && anchorRef.current.contains(event.target)) {
      return;
    }

    setOpen(false);
  };

  const handleChange = (newLang) => {
    setSelectedLang(newLang);
    changeLang(newLang);
    localStorage.setItem("lang", newLang);
    setOpen(false);
  };

  return (
    <Stack direction="row" alignItems="center" spacing={1}>
      <Avatar
        alt="en/tr"
        src={langHub.find((item) => item.label === selectedLang)?.icon}
        sx={{ width: "20px", height: "20px", cursor: "pointer" }}
        onClick={handleToggle}
        ref={anchorRef}
        aria-controls={open ? "menu-list-grow" : undefined}
        aria-haspopup="true"
      />
      <Popper
        open={open}
        anchorEl={anchorRef.current}
        role={undefined}
        transition
        disablePortal
      >
        {({ TransitionProps, placement }) => (
          <ClickAwayListener onClickAway={handleClose}>
            <Menu
              id="menu-list-grow"
              anchorEl={anchorRef.current}
              open={open}
              onClose={handleClose}
              PaperProps={{
                style: {
                  width: "150px",
                  marginTop: 3,
                  backgroundColor: "#313131",
                  color: "#949494",
                  zIndex: 10000,
                },
              }}
            >
              <MenuList
                autoFocusItem={open}
                onKeyDown={(event) => {
                  if (event.key === "Tab") {
                    event.preventDefault();
                    setOpen(false);
                  }
                }}
              >
                {langHub.map((item) => (
                  <MenuItem
                    key={item.label}
                    onClick={() => handleChange(item.label)}
                  >
                    <Stack direction="row" spacing={1} alignItems="center">
                      <Avatar
                        alt="en/tr"
                        src={item.icon}
                        sx={{ width: "20px", height: "20px" }}
                      />
                      <Typography
                        variant="h5"
                        sx={{
                          textTransform: "uppercase",
                          fontSize: "12px",
                          fontFamily: "'Public Sans', sans-serif",
                        }}
                      >
                        {item.label}
                      </Typography>
                    </Stack>
                  </MenuItem>
                ))}
              </MenuList>
            </Menu>
          </ClickAwayListener>
        )}
      </Popper>
    </Stack>
  );
}
